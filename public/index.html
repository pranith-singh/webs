<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Azure SQL Dashboard</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Animate.css -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body {
      background: linear-gradient(135deg, #89f7fe, #66a6ff);
      min-height: 100vh;
      padding: 30px;
    }
    .card { transition: 0.3s; }
    .card:hover { transform: translateY(-5px); box-shadow: 0 10px 25px rgba(0,0,0,0.3); }
    #usersTable th { background-color: #0d6efd; color: white; }
  </style>
</head>
<body>
  <div class="container">
    
    <!-- Header -->
    <h1 class="text-center text-white mb-4 animate__animated animate__fadeInDown">
      üöÄ Azure SQL Dashboard
    </h1>

    <div class="row">
      <!-- Form -->
      <div class="col-md-6">
        <div class="card shadow-lg mb-4">
          <div class="card-body">
            <h3 class="text-primary mb-3">‚ûï Add User</h3>
            <form id="userForm" class="row g-3">
              <div class="col-md-6"><input type="text" id="name" class="form-control" placeholder="Full Name" required></div>
              <div class="col-md-6"><input type="email" id="email" class="form-control" placeholder="Email" required></div>
              <div class="col-md-6"><input type="text" id="phone" class="form-control" placeholder="Phone"></div>
              <div class="col-md-6"><input type="text" id="city" class="form-control" placeholder="City"></div>
              <div class="col-md-12"><input type="text" id="role" class="form-control" placeholder="Role / Job Title"></div>
              <div class="col-md-12 d-grid">
                <button type="submit" class="btn btn-success">Save User</button>
              </div>
            </form>
            <div id="messageArea" class="mt-3"></div>
          </div>
        </div>
      </div>

      <!-- Users Table -->
      <div class="col-md-6">
        <div class="card shadow-lg mb-4">
          <div class="card-body">
            <h3 class="text-primary mb-3">üìã Users</h3>
            <div class="table-responsive">
              <table class="table table-striped table-hover" id="usersTable">
                <thead>
                  <tr>
                    <th>ID</th><th>Name</th><th>Email</th><th>Phone</th><th>City</th><th>Role</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Chart -->
    <div class="card shadow-lg">
      <div class="card-body">
        <h3 class="text-primary mb-3">üìä Roles Distribution</h3>
        <canvas id="rolesChart"></canvas>
      </div>
    </div>

  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    const form = document.getElementById("userForm");
    const msgArea = document.getElementById("messageArea");
    const usersTableBody = document.querySelector("#usersTable tbody");
    let rolesChart;

    // Fetch & display users
    async function loadUsers() {
      const res = await fetch("/db");
      const users = await res.json();

      // Update table
      usersTableBody.innerHTML = "";
      users.forEach(u => {
        const row = `<tr>
          <td>${u.Id}</td><td>${u.Name}</td><td>${u.Email}</td>
          <td>${u.Phone || ""}</td><td>${u.City || ""}</td><td>${u.Role || ""}</td>
        </tr>`;
        usersTableBody.innerHTML += row;
      });

      // Update chart
      updateChart(users);
    }

    // Update roles chart
    function updateChart(users) {
      const counts = {};
      users.forEach(u => {
        const role = u.Role || "Unknown";
        counts[role] = (counts[role] || 0) + 1;
      });

      const ctx = document.getElementById("rolesChart").getContext("2d");
      if (rolesChart) rolesChart.destroy();
      rolesChart = new Chart(ctx, {
        type: "pie",
        data: {
          labels: Object.keys(counts),
          datasets: [{
            data: Object.values(counts),
            backgroundColor: ["#0d6efd","#198754","#ffc107","#dc3545","#6f42c1"]
          }]
        }
      });
    }

    // Handle form submit
    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const user = {
        name: document.getElementById("name").value,
        email: document.getElementById("email").value,
        phone: document.getElementById("phone").value,
        city: document.getElementById("city").value,
        role: document.getElementById("role").value
      };

      const res = await fetch("/users", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(user)
      });

      msgArea.innerHTML = "";
      if (res.ok) {
        msgArea.innerHTML = `<div class="alert alert-success animate__animated animate__fadeIn">‚úÖ User saved!</div>`;
        form.reset();
        loadUsers();
      } else {
        msgArea.innerHTML = `<div class="alert alert-danger animate__animated animate__fadeIn">‚ùå Failed to save user</div>`;
      }
      setTimeout(() => msgArea.innerHTML = "", 3000);
    });

    // Load on page start
    loadUsers();
  </script>
</body>
</html>
